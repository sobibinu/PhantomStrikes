{% extends "base.html" %}

{% block title %}PhantomStrike - Scan Results{% endblock %}

{% block head %}
<style>
    .result-card {
        transition: all 0.3s ease;
    }
    .result-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
    }
    
    .severity-high {
        background-color: rgba(245, 101, 101, 0.2);
        border-left: 4px solid #F56565;
    }
    
    .severity-medium {
        background-color: rgba(237, 137, 54, 0.2);
        border-left: 4px solid #ED8936;
    }
    
    .severity-low {
        background-color: rgba(72, 187, 120, 0.2);
        border-left: 4px solid #48BB78;
    }
    
    .vulnerability-details {
        display: none;
    }
    
    .vulnerability-details.active {
        display: block;
    }
    
    .vulnerability-item {
        cursor: pointer;
    }
    
    .code-block {
        background-color: #1a1d24;
        padding: 1rem;
        border-radius: 0.375rem;
        font-family: monospace;
        white-space: pre-wrap;
        overflow-x: auto;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .pulse-animation {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto">
    <!-- Page Header -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-white">Scan Results</h1>
            <p class="text-gray-400 mt-2">
                Target: <span class="text-phantom-accent">{{ scan.target_url }}</span>
            </p>
        </div>
        <div class="mt-4 md:mt-0 flex space-x-3">
            {% if current_user.is_authenticated %}
            <div class="dropdown-container relative" id="exportDropdown">
                <button class="bg-phantom-accent hover:bg-teal-600 text-white font-medium py-2 px-4 rounded-md transition duration-300 flex items-center">
                    <i class="fas fa-download mr-2"></i> Export Results
                    <i class="fas fa-caret-down ml-2"></i>
                </button>
                <div class="dropdown-menu absolute right-0 mt-2 w-48 bg-phantom-secondary rounded-md shadow-lg z-10 hidden">
                    <a href="{{ url_for('main.export_result', scan_id=scan.id, format='json') }}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-phantom-primary hover:text-white">
                        <i class="far fa-file-code mr-2"></i> Export as JSON
                    </a>
                    <a href="{{ url_for('main.export_result', scan_id=scan.id, format='csv') }}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-phantom-primary hover:text-white">
                        <i class="far fa-file-excel mr-2"></i> Export as CSV
                    </a>
                    <a href="{{ url_for('main.export_result', scan_id=scan.id, format='pdf') }}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-phantom-primary hover:text-white">
                        <i class="far fa-file-pdf mr-2"></i> Export as PDF
                    </a>
                </div>
            </div>
            {% endif %}
            <a href="{{ url_for('main.scan') }}" class="bg-phantom-secondary hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md transition duration-300">
                <i class="fas fa-search mr-2"></i> New Scan
            </a>
        </div>
    </div>

    <!-- Scan Status Card -->
    <div class="bg-phantom-secondary rounded-lg shadow-md p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <!-- Scan Information -->
            <div class="md:col-span-2">
                <h2 class="text-xl font-bold mb-4 text-white">Scan Information</h2>
                <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                    <div class="text-gray-400 text-sm">Scan ID:</div>
                    <div class="text-white text-sm">{{ scan.id }}</div>
                    
                    <div class="text-gray-400 text-sm">Scan Type:</div>
                    <div class="text-white text-sm">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if scan.scan_type == 'light' %}bg-blue-800 text-blue-100
                            {% elif scan.scan_type == 'medium' %}bg-yellow-800 text-yellow-100
                            {% elif scan.scan_type == 'deep' %}bg-red-800 text-red-100
                            {% else %}bg-purple-800 text-purple-100{% endif %}">
                            {{ scan.scan_type }}
                        </span>
                    </div>
                    
                    <div class="text-gray-400 text-sm">Status:</div>
                    <div class="text-white text-sm">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if scan.status == 'completed' %}bg-green-800 text-green-100
                            {% elif scan.status == 'running' %}bg-blue-800 text-blue-100
                            {% elif scan.status == 'failed' %}bg-red-800 text-red-100
                            {% else %}bg-yellow-800 text-yellow-100{% endif %}">
                            {{ scan.status }}
                        </span>
                    </div>
                    
                    <div class="text-gray-400 text-sm">Started:</div>
                    <div class="text-white text-sm">{{ scan.start_time | replace('T', ' ') if scan.start_time else 'N/A' }}</div>
                    
                    <div class="text-gray-400 text-sm">Completed:</div>
                    <div class="text-white text-sm">{{ scan.end_time | replace('T', ' ') if scan.end_time else 'Running...' }}</div>
                </div>
            </div>
            
            <!-- Severity Distribution -->
            <div class="md:col-span-2">
                <h2 class="text-xl font-bold mb-4 text-white">Severity Distribution</h2>
                <div class="flex h-36 items-center justify-center">
                    <canvas id="severityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scan Results -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Vulnerabilities List -->
        <div class="lg:col-span-1">
            <div class="bg-phantom-secondary rounded-lg shadow-md overflow-hidden">
                <div class="px-6 py-4 border-b border-phantom-primary">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-bug mr-2 text-phantom-accent"></i>
                        Vulnerabilities
                        <span class="ml-2 px-2 py-1 text-xs rounded-full bg-phantom-primary text-white">
                            {{ scan.total_vulnerabilities }}
                        </span>
                    </h2>
                </div>
                
                {% if scan.status == 'running' %}
                <div class="p-6 text-center">
                    <div class="mb-4">
                        <i class="fas fa-spinner fa-spin text-4xl text-phantom-accent"></i>
                    </div>
                    <p class="text-white mb-2">Scan in progress...</p>
                    <p class="text-gray-400 text-sm mb-4">This may take a few minutes depending on the scan type.</p>
                    <div class="w-full bg-phantom-primary rounded-full h-2.5">
                        <div class="bg-phantom-accent h-2.5 rounded-full pulse-animation" style="width: 45%"></div>
                    </div>
                </div>
                {% elif scan.total_vulnerabilities == 0 %}
                <div class="p-6 text-center">
                    <div class="mb-4 text-green-400">
                        <i class="fas fa-check-circle text-4xl"></i>
                    </div>
                    <p class="text-white mb-2">No vulnerabilities detected</p>
                    <p class="text-gray-400 text-sm">The scan didn't find any security issues.</p>
                </div>
                {% else %}
                <div class="overflow-y-auto max-h-[500px]">
                    <ul class="divide-y divide-phantom-primary" id="vulnerabilityList">
                        {% if is_authenticated and 'vulnerabilities' in scan %}
                            {% for vuln in scan.vulnerabilities %}
                            <li class="vulnerability-item p-4 hover:bg-phantom-primary transition duration-200 flex items-start" data-vuln-id="{{ vuln.id }}">
                                <div class="flex-shrink-0">
                                    {% if vuln.severity|lower == 'high' %}
                                    <span class="flex h-3 w-3 relative">
                                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                        <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                                    </span>
                                    {% elif vuln.severity|lower == 'medium' %}
                                    <span class="flex h-3 w-3">
                                        <span class="relative inline-flex rounded-full h-3 w-3 bg-orange-500"></span>
                                    </span>
                                    {% else %}
                                    <span class="flex h-3 w-3">
                                        <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="ml-3 flex-1">
                                    <p class="text-white text-sm font-medium">{{ vuln.vulnerability_type }}</p>
                                    <p class="text-gray-400 text-xs mt-1">{{ vuln.location|truncate(30) }}</p>
                                </div>
                                <div class="ml-2">
                                    <span class="px-2 py-1 inline-flex text-xs leading-none font-semibold rounded-full 
                                        {% if vuln.severity|lower == 'high' %}bg-red-900 text-red-100
                                        {% elif vuln.severity|lower == 'medium' %}bg-yellow-800 text-yellow-100
                                        {% else %}bg-green-800 text-green-100{% endif %}">
                                        {{ vuln.severity }}
                                    </span>
                                </div>
                            </li>
                            {% endfor %}
                        {% elif scan.total_vulnerabilities > 0 %}
                            <li class="p-4 text-center">
                                {% if is_authenticated %}
                                    <p class="text-gray-400">Loading vulnerability details...</p>
                                {% else %}
                                    <p class="text-gray-400">Sign in to view detailed vulnerability information</p>
                                    <a href="{{ url_for('auth.login') }}" class="block mt-3 text-phantom-accent hover:underline">Log in</a>
                                {% endif %}
                            </li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Vulnerability Details -->
        <div class="lg:col-span-2" id="vulnerabilityDetails">
            {% if not is_authenticated %}
            <!-- Guest user prompt -->
            <div class="bg-phantom-secondary rounded-lg shadow-md p-6 text-center">
                <div class="mb-6">
                    <img src="https://pixabay.com/get/g9782d8a853b390943ceb46eef29e4670db88e2fdd85560f140109a0d797d9d687930bf5f497a929ff8023c6b9460ca931eaa8a63f0a4a5a619393e96427d7839_1280.jpg" alt="Unlock full access" class="h-40 mx-auto object-cover rounded-lg shadow-lg">
                </div>
                <h2 class="text-2xl font-bold text-white mb-4">Detailed Results Require Authentication</h2>
                <p class="text-gray-300 mb-6">
                    Sign up or log in to access detailed vulnerability information, remediation suggestions, and export functionality.
                </p>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 justify-center">
                    <a href="{{ url_for('auth.login') }}" class="bg-phantom-accent hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-md transition duration-300">
                        Log In
                    </a>
                    <a href="{{ url_for('auth.signup') }}" class="bg-phantom-secondary hover:bg-gray-700 border border-phantom-accent text-white font-bold py-2 px-6 rounded-md transition duration-300">
                        Sign Up
                    </a>
                </div>
            </div>
            
            <!-- Summary for guests -->
            <div class="bg-phantom-secondary rounded-lg shadow-md p-6 mt-6">
                <h2 class="text-xl font-bold text-white mb-4">Scan Summary</h2>
                <p class="text-gray-300 mb-4">
                    {% if scan.total_vulnerabilities > 0 %}
                        This scan detected <strong class="text-phantom-accent">{{ scan.total_vulnerabilities }}</strong> potential vulnerabilities in the target, including:
                    {% else %}
                        No vulnerabilities were detected in this scan.
                    {% endif %}
                </p>
                
                {% if scan.total_vulnerabilities > 0 %}
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="p-4 bg-red-900 bg-opacity-20 rounded-lg text-center">
                        <p class="text-red-400 font-bold text-2xl">{{ scan.high_severity }}</p>
                        <p class="text-gray-300 text-sm">High Severity</p>
                    </div>
                    <div class="p-4 bg-yellow-800 bg-opacity-20 rounded-lg text-center">
                        <p class="text-yellow-400 font-bold text-2xl">{{ scan.medium_severity }}</p>
                        <p class="text-gray-300 text-sm">Medium Severity</p>
                    </div>
                    <div class="p-4 bg-green-800 bg-opacity-20 rounded-lg text-center">
                        <p class="text-green-400 font-bold text-2xl">{{ scan.low_severity }}</p>
                        <p class="text-gray-300 text-sm">Low Severity</p>
                    </div>
                </div>
                
                <p class="text-gray-300 text-sm">
                    Sign in to view detailed information about each vulnerability, including:
                </p>
                <ul class="mt-2 text-gray-400 space-y-1 ml-6 list-disc">
                    <li>Precise vulnerability locations</li>
                    <li>Technical descriptions and evidence</li>
                    <li>AI-powered remediation suggestions</li>
                    <li>Code examples for fixing issues</li>
                    <li>Export functionality for reports</li>
                </ul>
                {% endif %}
            </div>
            {% elif is_authenticated and scan.vulnerabilities and scan.vulnerabilities|length > 0 %}
            <div class="bg-phantom-secondary rounded-lg shadow-md p-6" id="vulnerabilityDetailPanel">
                <p class="text-gray-300 text-center">
                    Select a vulnerability from the list to view details
                </p>
            </div>
            
            {% for vuln in scan.vulnerabilities %}
            <div class="vulnerability-details bg-phantom-secondary rounded-lg shadow-md p-6 severity-{{ vuln.severity|lower }}" id="vuln-details-{{ vuln.id }}">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-xl font-bold text-white">{{ vuln.vulnerability_type }}</h2>
                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                        {% if vuln.severity|lower == 'high' %}bg-red-900 text-red-100
                        {% elif vuln.severity|lower == 'medium' %}bg-yellow-800 text-yellow-100
                        {% else %}bg-green-800 text-green-100{% endif %}">
                        {{ vuln.severity }} Severity
                    </span>
                </div>
                
                <div class="mb-4">
                    <h3 class="text-sm font-medium text-gray-300 mb-1">Location</h3>
                    <p class="text-white bg-phantom-primary p-2 rounded">{{ vuln.location }}</p>
                </div>
                
                <div class="mb-4">
                    <h3 class="text-sm font-medium text-gray-300 mb-1">Description</h3>
                    <p class="text-gray-300">{{ vuln.description }}</p>
                </div>
                
                <div class="mb-4">
                    <h3 class="text-sm font-medium text-gray-300 mb-1">Evidence</h3>
                    <div class="bg-phantom-primary p-3 rounded text-gray-300 text-sm">
                        {{ vuln.evidence }}
                    </div>
                </div>
                
                <div class="mb-4">
                    <h3 class="text-sm font-medium text-gray-300 mb-1">Remediation</h3>
                    <p class="text-gray-300">{{ vuln.remediation }}</p>
                </div>
                
                {% if vuln.remediation_code %}
                <div class="mb-4">
                    <h3 class="text-sm font-medium text-gray-300 mb-1">Example Fix</h3>
                    <div class="code-block text-green-300 text-sm">{{ vuln.remediation_code }}</div>
                </div>
                {% endif %}
                
                <div class="flex justify-end mt-6">
                    <button type="button" class="bg-phantom-primary hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md transition duration-300 text-sm back-to-list">
                        <i class="fas fa-arrow-left mr-1"></i> Back to List
                    </button>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="bg-phantom-secondary rounded-lg shadow-md p-6">
                <div class="text-center">
                    {% if scan.status == 'running' %}
                    <div class="mb-6">
                        <i class="fas fa-spinner fa-spin text-4xl text-phantom-accent"></i>
                    </div>
                    <h2 class="text-xl font-bold text-white mb-3">Scan in progress</h2>
                    <p class="text-gray-300 mb-4">
                        Please wait while we analyze the target for vulnerabilities. This page will automatically update when the scan is complete.
                    </p>
                    <div class="w-full bg-phantom-primary rounded-full h-2.5 mb-4">
                        <div class="bg-phantom-accent h-2.5 rounded-full pulse-animation" style="width: 45%"></div>
                    </div>
                    <p class="text-gray-400 text-sm">
                        Scan started at: {{ scan.start_time | replace('T', ' ') if scan.start_time else 'N/A' }}
                    </p>
                    {% elif scan.status == 'failed' %}
                    <div class="mb-6 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-white mb-3">Scan Failed</h2>
                    <p class="text-gray-300 mb-4">
                        There was a problem completing this scan. Please try again or scan a different target.
                    </p>
                    <a href="{{ url_for('main.scan') }}" class="bg-phantom-accent hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-md transition duration-300">
                        Start New Scan
                    </a>
                    {% else %}
                    <div class="mb-6 text-green-400">
                        <i class="fas fa-check-circle text-4xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-white mb-3">Scan Completed</h2>
                    <p class="text-gray-300 mb-4">
                        No vulnerabilities were detected in this scan.
                    </p>
                    <a href="{{ url_for('main.scan') }}" class="bg-phantom-accent hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-md transition duration-300">
                        Start New Scan
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/export.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Create severity distribution chart
    const ctx = document.getElementById('severityChart').getContext('2d');
    const severityChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['High', 'Medium', 'Low'],
            datasets: [{
                data: [{{ scan.high_severity or 0 }}, {{ scan.medium_severity or 0 }}, {{ scan.low_severity or 0 }}],
                backgroundColor: [
                    '#F56565', // red for high
                    '#ED8936', // orange for medium
                    '#48BB78'  // green for low
                ],
                borderColor: '#2D3748',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            legend: {
                position: 'bottom',
                labels: {
                    fontColor: '#E2E8F0',
                    fontSize: 12,
                    padding: 20
                }
            },
            tooltips: {
                backgroundColor: '#1A202C',
                titleFontColor: '#E2E8F0',
                bodyFontColor: '#E2E8F0',
                bodySpacing: 4,
                xPadding: 12,
                mode: 'nearest',
                intersect: 0,
                position: 'nearest'
            },
            cutoutPercentage: 70
        }
    });

    // Handle vulnerability selection
    const vulnerabilityItems = document.querySelectorAll('.vulnerability-item');
    const vulnerabilityDetails = document.querySelectorAll('.vulnerability-details');
    const detailPanel = document.getElementById('vulnerabilityDetailPanel');

    vulnerabilityItems.forEach(item => {
        item.addEventListener('click', function() {
            const vulnId = this.getAttribute('data-vuln-id');
            
            // Hide all details panels
            vulnerabilityDetails.forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Show the selected vulnerability details
            const targetPanel = document.getElementById(`vuln-details-${vulnId}`);
            if (targetPanel) {
                targetPanel.classList.add('active');
                if (detailPanel) detailPanel.style.display = 'none';
            }
            
            // Mark this item as active
            vulnerabilityItems.forEach(vItem => {
                vItem.classList.remove('bg-phantom-primary');
            });
            this.classList.add('bg-phantom-primary');
        });
    });

    // Back to list buttons
    const backButtons = document.querySelectorAll('.back-to-list');
    backButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Hide all details panels
            vulnerabilityDetails.forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Show the empty state panel
            if (detailPanel) detailPanel.style.display = 'block';
            
            // Remove active state from list items
            vulnerabilityItems.forEach(vItem => {
                vItem.classList.remove('bg-phantom-primary');
            });
        });
    });

    // Toggle export dropdown
    const exportDropdown = document.getElementById('exportDropdown');
    if (exportDropdown) {
        const dropdownButton = exportDropdown.querySelector('button');
        const dropdownMenu = exportDropdown.querySelector('.dropdown-menu');
        
        dropdownButton.addEventListener('click', function() {
            dropdownMenu.classList.toggle('hidden');
        });
        
        // Close dropdown when clicking elsewhere
        document.addEventListener('click', function(event) {
            if (!exportDropdown.contains(event.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });
    }

    // Auto-refresh for running scans
    {% if scan.status == 'running' %}
    const checkStatus = function() {
        fetch(`{{ url_for('main.scan_status', scan_id=scan.id) }}`)
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'running') {
                    // Reload page when scan completes
                    window.location.reload();
                } else {
                    // Check again in 5 seconds
                    setTimeout(checkStatus, 5000);
                }
            })
            .catch(error => {
                console.error('Error checking scan status:', error);
                // Try again after 10 seconds if there was an error
                setTimeout(checkStatus, 10000);
            });
    };
    
    // Start the status checking
    setTimeout(checkStatus, 5000);
    {% endif %}
});
</script>
{% endblock %}
